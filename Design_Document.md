# BED/BAM Processing Pipeline Setup Plan

## Data Sources
Bam:  
https://ftp.ncbi.nlm.nih.gov/ReferenceSamples/giab/data/NA12878/NIST_NA12878_HG001_HiSeq_300x/

Bed:  
https://www.twistbioscience.com/resources/data-files/ngs-human-core-exome-panel-bed-file

## Revised Architecture
```mermaid
graph TD
    A[Parse Arguments] --> B{Validate Inputs}
    B -->|Missing Files| C[Exit with error]
    B -->|Valid| D[Create Directories]
    D --> E[Run mosdepth]
    E --> F{Success?}
    F -->|No| G[Cleanup and exit]
    F -->|Yes| H[Extract Coverage Data]
    H --> I{Keep Intermediates?}
    I -->|No| J[Remove Other Temp Files]
    I -->|Yes| K[Retain All Files]
    J --> L[Final Output (.coverage.bed)]
    K --> L
```

## Key Components
1. **Input Validation**  
   - Mandatory BED/BAM path checks (existence, readability)
   - BAM format and index validation using `pysam`
2. **Directory Management**  
   - Auto-create Intermediate_Files/ and Result_cov_file/
3. **mosdepth Integration**  
   - Subprocess execution with error handling
4. **Output Processing**  
   - Copying content directly from mosdepth's `.regions.bed.gz` output.
5. **Cleanup System**  
   - Conditional removal of intermediate files (excluding `.regions.bed.gz`) based on `--keep-intermediates` flag.

## Input/Output Structure
```
Input:
├── Bed_and_Bam_file/
│   ├── test_fixed.bed (default --bed) OR [specified_bed].bed
│   └── [input].bam (--bam)
Output:
├── Intermediate_Files/ (conditional)
│   └── {output_prefix}.regions.bed.gz (and potentially others)
└── Result_cov_file/
    └── [output_prefix].coverage.bed
```

## Command-Line Interface

The script uses `argparse` to handle command-line arguments:

- `--bed` (Required): Path to the input BED file. Default: `Bed_and_Bam_file/test_fixed.bed`.
- `--bam` (Required): Path to the input BAM file.
- `--output-prefix` (Required): Prefix for output files.
- `--full-bed` (Optional): Flag to indicate usage of a full exome BED file (Note: This flag is defined but not currently implemented in the script logic).
- `--keep-intermediates` (Optional): Flag to prevent deletion of intermediate files generated by `mosdepth`.
- `-h`, `--help`, `--hlep` (Optional): Display the help message and exit.

## Implementation Notes
- Python 3.8+ required.
- Uses `argparse` for CLI interface.
- Requires `pysam` for BAM validation.
- Requires `mosdepth` command-line tool to be installed and in PATH.
- Uses `sys.exit` for error reporting (not comprehensive logging).